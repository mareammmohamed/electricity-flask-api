<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - User Input</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    />
    <link rel="stylesheet" href="user.css" />
  </head>
  <body>
    <div class="d-flex">
      <div class="sidebar">
        <ul class="nav nav-pills flex-column mb-auto">
          <li class="nav-item">
            <a href="index.html" class="nav-link"
              ><i class="fa-regular fa-house"></i> Dashboard</a
            >
          </li>
          <li class="nav-item">
            <a href="user.html" class="nav-link active"
              ><i class="fa-solid fa-bolt"></i> User Input</a
            >
          </li>
          <li>
            <a href="alerts.html" class="nav-link"
              ><i class="fa-regular fa-bell"></i> Alerts</a
            >
          </li>
        </ul>
      </div>

      <div class="content-area">
        <h2>User Input</h2>
        <div
          class="content-area d-flex justify-content-center align-items-center"
          style="min-height: 80vh; padding: 40px"
        >
          <div
            class="card text-black"
            style="max-width: 700px; width: 100%; padding: 20px"
          >
            <div class="card-body">
              <h4>Provide Your Energy Data</h4>
              <p class="para">
                Help us analyze your energy consumption by providing details
                about your household and devices.
              </p>

              <form id="energyForm">
                <h5>Device Details</h5>
                <div class="mb-3">
                  <label class="form-label">Number of Devices</label>
                  <input
                    type="number"
                    class="form-control"
                    id="numDevices"
                    min="1"
                    max="10"
                    value="1"
                  />
                </div>

                <div id="devicesContainer"></div>

                <h5>Consumption Data</h5>
                <div class="mb-3">
                  <label class="form-label"
                    >Current Month Consumption (kWh)</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="monthly_input"
                    placeholder="e.g., 250"
                    min="0"
                    step="0.1"
                    required
                  />
                </div>

                <div class="form-buttons">
                  <button type="submit" class="btn btn-primary">
                    Submit Data
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const form = document.getElementById("energyForm");
      const numDevicesInput = document.getElementById("numDevices");
      const devicesContainer = document.getElementById("devicesContainer");

      const deviceOptions = [
        { value: "fridge", label: "Fridge", power: 0.15 },
        { value: "ac", label: "Air Conditioner", power: 1.2 },
        { value: "washer", label: "Washer", power: 0.6 },
        { value: "oven", label: "Oven", power: 1.0 },
        { value: "heater", label: "Heater", power: 1.5 },
        { value: "iron", label: "Iron", power: 0.8 },
        { value: "tv", label: "TV", power: 0.08 },
      ];

      function generateDeviceFields(count) {
        devicesContainer.innerHTML = "";
        for (let i = 1; i <= count; i++) {
          const row = document.createElement("div");
          row.classList.add("row", "mb-3", "g-2", "device-item");

          const optionsHtml = deviceOptions
            .map(
              (opt) =>
                `<option value="${opt.value}" data-power="${opt.power}">${opt.label}</option>`
            )
            .join("");

          row.innerHTML = `
            <div class="col">
              <label class="form-label">Device ${i}</label>
              <select class="form-select device-type" required>
                <option value="" selected disabled>Choose Device...</option>
                ${optionsHtml}
              </select>
            </div>
            <div class="col">
              <label class="form-label">Daily Hours</label>
              <input type="number" class="form-control device-hours" placeholder="0-24" min="0" max="24" step="0.5" required>
            </div>
          `;
          devicesContainer.appendChild(row);
        }

        document.querySelectorAll(".remove-device").forEach((btn) => {
          btn.addEventListener("click", function () {
            const currentCount = parseInt(numDevicesInput.value);
            if (currentCount > 1) {
              numDevicesInput.value = currentCount - 1;
              generateDeviceFields(currentCount - 1);
            }
          });
        });
      }

      generateDeviceFields(1);

      numDevicesInput.addEventListener("input", function () {
        const count = Math.min(Math.max(parseInt(this.value) || 1, 1), 10);
        generateDeviceFields(count);
      });

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const monthlyConsumptionInput = document.getElementById("monthly_input").value;

        const payload = {
          monthly_consumption_input: parseFloat(monthlyConsumptionInput),
          devices: [],
        };

        const deviceRows = document.querySelectorAll(".device-item");
        deviceRows.forEach((row) => {
          const deviceSelect = row.querySelector(".device-type");
          const deviceName = deviceSelect.value;
          const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
          const devicePower = selectedOption.getAttribute("data-power");
          const hoursValue = row.querySelector(".device-hours").value;

          if (deviceName && hoursValue) {
            const deviceLabel = deviceOptions.find((d) => d.value === deviceName)?.label || deviceName;
            payload.devices.push({
              device_type: deviceName,
              hours_per_day: parseFloat(hoursValue),
              device_name: deviceLabel,
              device_power: parseFloat(devicePower),
            });
          }
        });

        try {
          const response = await fetch("http://127.0.0.1:5000/submit_consumption", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          if (response.ok) {
            const dataToStore = result.result || result; 
            
            // --- التعديلات المطلوبة لربط الصفحات ببعضها ---
            localStorage.setItem("energyData", JSON.stringify(payload));
            localStorage.setItem("lastResult", JSON.stringify(dataToStore));
            localStorage.setItem("prediction_result", JSON.stringify(dataToStore));

            window.location.href = "index.html";
          } else {
            alert("Error: " + (result.error || "Unknown error"));
          }
        } catch (err) {
          console.error("Connection failed:", err);
          alert("Connection failed. Is Flask server running?");
        }
      });

      function calculatePredictionConfidence(result) {
        let confidence = 85; 
        if (result.prediction_source === "موديل ML") {
          confidence += 10;
        }
        const deviceCount = result.devices_entered?.length || 0;
        confidence += Math.min(deviceCount * 2, 10);
        const input = result.user_input_monthly_kwh;
        const calculated = result.calculated_monthly_kwh;
        if (input > 0 && calculated > 0) {
          const diffRatio = Math.abs(input - calculated) / input;
          if (diffRatio > 0.5) {
            confidence -= 15;
          } else if (diffRatio > 0.3) {
            confidence -= 10;
          } else if (diffRatio > 0.1) {
            confidence -= 5;
          }
        }
        return Math.min(Math.max(confidence, 60), 95);
      }
    </script>
  </body>
</html>