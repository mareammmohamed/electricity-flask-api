<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    />
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* إضافة ستايل لعرض بطاقتين فقط في الصف الثاني */
      .cards-row:last-child .card:nth-child(2),
      .cards-row:last-child .card:nth-child(3) {
        display: none;
      }
      .cards-row:last-child .card {
        flex: 0 0 50%;
        max-width: 50%;
      }
    </style>
  </head>
  <body>
    <div class="d-flex">
      <div class="sidebar">
        <ul class="nav nav-pills flex-column mb-auto">
          <li class="nav-item">
            <a href="index.html" class="nav-link active"
              ><i class="fa-regular fa-house"></i> Dashboard</a
            >
          </li>
          <li class="nav-item">
            <a href="user.html" class="nav-link"
              ><i class="fa-solid fa-bolt"></i> User Input</a
            >
          </li>
          <li>
            <a href="alerts.html" class="nav-link"
              ><i class="fa-regular fa-bell"></i> Alerts</a
            >
          </li>
        </ul>
      </div>

      <div class="content-area">
        <h2>Dashboard Overview</h2>
        <div class="cards-row">
          <div class="card text-black h-100">
            <div class="card-body">
              <h5 class="card-title">Monthly Consumption</h5>
              <p class="card-text cp">
                <span id="monthlyConsumption">0</span> kWh
              </p>
              <p class="card-subtitle mb-2 text-muted" id="consumptionDate"></p>
            </div>
          </div>
          <div class="card text-black h-100">
            <div class="card-body">
              <h5 class="card-title">Predicted Next Month Usage</h5>
              <p class="card-text cp">
                <span id="predictedNextMonth">0</span> kWh
              </p>
              <p
                class="card-subtitle mb-2 text-muted"
                id="predictionSource"
              ></p>
            </div>
          </div>
          <div class="card text-black h-100">
            <div class="card-body">
              <h5 class="card-title">Estimated Bill</h5>
              <p class="card-text cp">$<span id="estimatedBill">0.00</span></p>
              <p class="card-subtitle mb-2 text-muted">Based on $0.28/kWh</p>
            </div>
          </div>
        </div>
        <div class="cards-row">
          <!-- تم إزالة بطاقة Change from Last Month -->
          <div class="card text-black h-100">
            <div class="card-body">
              <h5 class="card-title">Prediction Confidence</h5>
              <p class="card-text cp">
                <span id="predictionConfidence">0</span>%
              </p>
              <p class="card-subtitle mb-2 text-muted">Model Accuracy</p>
            </div>
          </div>
          <!-- تم إخفاء البطاقة الثانية -->
          <div class="card text-black h-100" style="display: none">
            <!-- بطاقة فارغة مخفية -->
          </div>
          <div class="card text-black h-100">
            <div class="card-body">
              <h5 class="card-title">Potential Savings</h5>
              <p class="card-text cp">
                $<span id="potentialSavings">0.00</span>
              </p>
              <p class="card-subtitle mb-2 text-muted">
                15% saving possible if alerts recommendations are followed
              </p>
            </div>
          </div>
        </div>

        <h4 class="mt-5">Device Consumption Chart</h4>
        <canvas id="deviceChart" height="120"></canvas>

        <h4 class="mt-5">Device Consumption Details</h4>

        <table class="table table-bordered mt-3">
          <thead>
            <tr>
              <th>Device</th>
              <th>Hours Used</th>
              <th>Consumption (kWh)</th>
            </tr>
          </thead>
          <tbody id="consumptionTable"></tbody>
        </table>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      let deviceChart;

      function updatePredictionSource(source) {
        const sourceElement = document.getElementById("predictionSource");
        if (source === "موديل ML" || source === "AI Prediction") {
          sourceElement.innerHTML =
            '<i class="fas fa-robot text-primary"></i> AI Prediction';
          sourceElement.className = "card-subtitle mb-2 text-primary";
        } else {
          sourceElement.innerHTML =
            '<i class="fas fa-calculator text-warning"></i> Estimated';
          sourceElement.className = "card-subtitle mb-2 text-warning";
        }
      }

      // دالة لتصفية الـ alerts وإزالة التحذيرات غير المرغوبة
      function filterAlerts(alertsData) {
        if (!alertsData) return [];

        return alertsData.filter((alert) => {
          // إزالة تحذيرات الفرن (oven) إذا كانت ساعات التشغيل منطقية
          if (alert.title && alert.title.includes("Oven")) {
            // البحث عن ساعات التشغيل في الرسالة
            const message = alert.message || "";
            const hoursMatch = message.match(/(\d+\.?\d*)\s*hours?/i);
            if (hoursMatch) {
              const hours = parseFloat(hoursMatch[1]);
              // إذا كانت الساعات أقل من 4 ساعات يومياً، إزالة التحذير
              if (hours <= 4) {
                return false;
              }
            }
          }

          // يمكن إضافة شروط أخرى لتصفية تحذيرات أخرى
          // إزالة تحذيرات الأجهزة التي تعتبر استهلاكها طبيعي
          const normalDevices = ["TV", "Refrigerator", "Lighting"];
          for (const device of normalDevices) {
            if (alert.title && alert.title.includes(device)) {
              return false;
            }
          }

          return true;
        });
      }

      async function loadDashboardData() {
        try {
          const predictionResult = JSON.parse(
            localStorage.getItem("prediction_result")
          );

          if (predictionResult) {
            document.getElementById("monthlyConsumption").textContent =
              predictionResult.user_input_monthly_kwh || 0;
            document.getElementById("predictedNextMonth").textContent =
              predictionResult.predicted_next_month || 0;
            document.getElementById("predictionConfidence").textContent =
              predictionResult.prediction_confidence || 85;

            // تم إزالة Change from Last Month
            // document.getElementById("changeFromLastMonth").textContent =
            //   predictionResult.change_percent || 0;

            document.getElementById("estimatedBill").textContent =
              predictionResult.estimated_bill || "0.00";
            document.getElementById("potentialSavings").textContent =
              predictionResult.potential_savings || "0.00";
            document.getElementById(
              "consumptionDate"
            ).textContent = `Updated: ${
              predictionResult.تاريخ_التحليل || new Date().toLocaleDateString()
            }`;

            // تم إزالة updateChangeIndicator
            updatePredictionSource(predictionResult.prediction_source);

            // --- التعديل هنا فقط لربط الجدول والشارت ---
            const devices = predictionResult.devices_entered || [];
            const consumptionMap = predictionResult.device_consumption || {};
            const table = document.getElementById("consumptionTable");
            table.innerHTML = "";

            const labels = [];
            const values = [];

            devices.forEach((device) => {
              // نستخدم device_type لجلب القيمة من مصفوفة الاستهلاك
              const deviceType = device.device_type;
              const deviceName = device.device_name || deviceType;
              const consumptionKwh = consumptionMap[deviceType] || 0;

              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${deviceName}</td>
                <td>${device.hours_per_day} hr</td>
                <td>${consumptionKwh.toFixed(2)} kWh</td>
              `;
              table.appendChild(row);

              labels.push(deviceName);
              values.push(consumptionKwh);
            });
            // --- نهاية التعديل ---

            const ctx = document.getElementById("deviceChart").getContext("2d");
            if (deviceChart) {
              deviceChart.destroy();
            }

            deviceChart = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: "Monthly Consumption (kWh)",
                    data: values,
                    backgroundColor: "rgba(54, 162, 235, 0.5)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
              },
            });
          }

          const alertsData = JSON.parse(localStorage.getItem("alerts_data"));
          const alertsDiv = document.getElementById("alertsContainer");
          if (alertsDiv) {
            alertsDiv.innerHTML = "";

            if (alertsData && alertsData.length > 0) {
              // تصفية الـ alerts لإزالة التحذيرات غير المرغوبة
              const filteredAlerts = filterAlerts(alertsData);

              if (filteredAlerts.length > 0) {
                filteredAlerts.forEach((alert) => {
                  const alertElement = document.createElement("div");
                  alertElement.className = `alert alert-${
                    alert.severity === "high"
                      ? "danger"
                      : alert.severity === "medium"
                      ? "warning"
                      : "info"
                  }`;
                  alertElement.innerHTML = `<strong>${alert.title}:</strong> ${alert.message}`;
                  alertsDiv.appendChild(alertElement);
                });
              } else {
                // إذا لم تبقى أي تحذيرات بعد التصفية، عرض رسالة طمأنة
                const noAlertsElement = document.createElement("div");
                noAlertsElement.className = "alert alert-success";
                noAlertsElement.innerHTML = `<strong><i class="fas fa-check-circle"></i> All Good:</strong> No critical alerts detected. Your energy consumption appears normal.`;
                alertsDiv.appendChild(noAlertsElement);
              }
            } else {
              // إذا لم توجد alerts مطلقاً
              const noDataElement = document.createElement("div");
              noDataElement.className = "alert alert-info";
              noDataElement.innerHTML = `<strong><i class="fas fa-info-circle"></i> No Alerts:</strong> Submit your energy data to see personalized alerts.`;
              alertsDiv.appendChild(noDataElement);
            }
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", loadDashboardData);
    </script>
  </body>
</html>
